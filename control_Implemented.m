%% Basic script to set up connection and give inputs to the manipulator.

% Setup of robot and input

%lCOM_Port = getAvailableComPort %create list of all serial ports of the system
dev=openSup('COM6') %create serial port object associated with the specified port

%setSup(0,0,0,0,0,0,0,0,450,450,450,450,450,450,dev); %set zero configuration
setSup(0,0,0,0,0,0,0,0,800,800,800,800,800,800,dev);

pause(5);

% values with alpha = 0.036
e_i_old = 0;
e_f_old = 0;
KP = 211.7 %378.1; 
KI = 1971.9 %2082;
KD = 11.45 %16.77;
alpha = 0.07053 %0.01868 
beta = 0.008763 %0.006163
%alpha_G = 0.7575;
%beta_G = 0.2045;
Ts = 0.025;
Input_op = 10;
Analog_op = 600;
%state_old = 650-Analog_op;
%state = state_old;

forceArray = [];
timeArray = [];
sineArray = [];

% For sinusoidal testing use this:
% Define parameters
period = 500; % Period of the sine wave in seconds
amplitude_max = 750; % Maximum amplitude
amplitude_min = 680; % Minimum amplitude

% For constant testing use this: desired_force = 680-Analog_op;

values = [0,65,59,64,65,88,81,91,81,96,123,147,138,162,172,183,168,145,167,101,114,101,120,82,76,128,158,161,199,174,159,94,109,89,180,179,189,180,183,184,179,184,177,164,170,177,187,184,179,165,195,179,177,183,171,185,182,166,169,157,158,152,158,175,163,133,133,74,167,186,155,173,168,156,100,102,162,151,156,172,164,159,171,133,109,96,154,188,196,180,162,151,108,108,105,145,175,208,181,176,160,115,110,102,164,164,207,184,196,145,113,128,100,166,184,190,196,177,161,185,138,95,108,126,142,189,193,186,171,156,168,157,143,117,101,106,179,170,200,181,183,186,170,174,155,108,107,95,160,184,178,178,148,171,175,139,109,103,119,170,177,194,185,188,168,167,157,131,104,91,187,185,184,159,186,169,164,161,102,112,105,138,171,201,194,188,171,161,109,137,125,110,174,168,190,181,181,171,126,129,135,158,166,161,154,104,106,137,147,167,175,184,152,107,107,109,177,182,183,184,181,185,183,143,156,105,103,128,184,176,183,172,143,109,130,110,107,123,183,185,183,173,159,128,106,95,117,184,181,184,180,184,152,129,116,124,113,94,113,128,144,104,119,119,108,112,110,136,110,105,104,93,129,112,105,106,104,105,113,79,140,103,113,107,108,106,111,115,97,78,105,101,109,99,98,117,101,84,95,114,91,98,100,88,101,112,92,113,91,97,74,94,95,107,97,104,101,94,97,103,83,88,95,119,100,102,93,92,88,95,98,108,91,96,88,93,78,110,107,86,93,91,91,86,91,93,108,89,81,97,104,93,95,92,103,69,98,85,92,102,110,96,102,109,122,105,81,97,81,102,91,90,89,124,114,103,112,91,87,98,102,98,88,103,98,99,89,91,113,96,79,99,96,108,85,78,98,113,94,90,93,96,76,99,102,99,103,102,122,104,86,92,105,130,100,98,84,98,118,104,99,118,86,93,126,97,105,105,98,99,100,87,99,100,64,94,111,98,94,96,103,103,112,88,88,93,99,97,95,102,116,93,128,92,103,89,116,103,92,92,94,102,103,98,103,95,90,103,107,99,99,103,109,96,124,93,95,98,121,94,99,105,103,114,116,119,115,90,106,101,100,104,105,136,173,147,162,100,111,101,108,157,178,193,154,162,176,112,107,104,160,178,175,187,174,142,149,101,115,102,157,182,181,186,179,130,109,106,114,164,182,190,180,177,159,150,137,106,95,107,140,184,195,190,190,160,130,125,112,173,181,177,168,173,162,120,102,111,165,173,169,185,183,156,124,103,123,184,195,185,200,183,171,166,181,113,102,95,161,185,177,179,185,183,159,135,98,147,182,173,186,177,184,150,150,129,117,125,177,184,194,195,187,167,178,162,159,109,99,105,163,208,183,189,184,171,167,123,117,121,175,194,187,164,186,144,163,184,155,103,112,113,164,207,171,192,190,186,174,161,126,139,100,162,172,171,185,183,176,147,118,115,169,167,188,182,190,172,158,152,108,84,118,174,202,196,190,189,175,160,144,109,105,105,177,187,173,184,202,159,175,171,140,112,110,110,179,191,189,188,167,166,160,143,115,97,98,185,182,191,211,186,181,158,176,170,118,104,121,142,179,181,190,188,145,140,140,110,111,120,125,171,207,180,173,152,129,99,117,110,170,191,212,191,206,192,161,163,107,109,122,166,189,204,138,147,111,107,118,155,181,173,168,158,111,111,105,110,143,175,176,198,180,126,102,104,113,111,162,120,157,127,109,149,111,113,112,95,103,109,131,102,130,141,115,119,135,103,124,96,92,108,135,106,106,91,71,83,94,93,156,168,164,125,109,113,107,110,104,109,103,100,111,102,103,100,86,103,107,95,108,100,104,92,105,96,115,97,104,110,104,98,94,120,105,100,100,100,97,101,101,100,111,95,85,108,75,82,92,115,105,99,115,103,98,113,100,101,91,71,91,96,101,94,113,123,115,100,95,103,96,105,119,101,98,98,109,87,102,117,111,112,97,92,111,101,96,94,104,100,105,89,101,123,119,96,119,94,93,94,121,85,80,89,99,99,103,120,121,96,95,84,87,103,111,90,122,103,105,107,103,110,105,106,103,106,105,96,107,88,90,107,101,97,99,88,112,101,108,110,111,98,95,87,124,87,97,101,101,99,82,114,107,128,96,105,106,98,100,72,118,101,116,111,113,107,103,109,104,81,94,104,87,104,99,130,103,114,110,108,110,104,99,100,121,103,117,124,111,103,106,102,120,88,103,121,115,112,109,103,115,175,176,198,180,126,102,104,113,111,162,120,157,127,109,149,111,113,112,95,103,109,131,102,130,141,115,119,135,103,124,96,92,108,135,106,106,91,71,83,94,93,156,168,164,125,109,113,107,110,104,109,103,100,111,102,103,100,86,103,107,95,108,100,104,92,105,96,115,97,104,110,104,98,94,120,105,100,100,100,97,101,101,100,111,95,85,108,75,82,92,115,105,99,115,103,98,113,100,101,91,71,91,96,101,94,113,123,115,100,95,103,96,105,119,101,98,98,109,87,102,117,111,112,97,92,111,101,96,94,104,100,105,89,101,123,119,96,119,94,93,94,121,85,80,89,99,99,103,120,121,96,95,84,87,103,111,90,122,103,105,107,103,110,105,106,103,106,105,96,107,88,90,107,101,97,99,88,112,101,108,110,111,98,95,87,124,87,97,101,101,99,82,114,107,128,96,105,106,98,100,72,118,101,116,111,113,107,103,109,104,81,94,104,87,104,99,130,103,114,110,108,110,104,99,100,121,103,117,124,111,103,106,102,120,88,103,121,115,112,109,103,115];


for t=0:1000

    % Generate sine wave
    sine = (amplitude_max - amplitude_min) / 2 * sin(2 * pi / period * t) + (amplitude_max + amplitude_min) / 2;
    desired_force = sine-Analog_op;

    data = fscanf(dev, '%d'); % Read the sensor value
    fprintf('%d\n', data);
    
    if t < 1
        data = Analog_op;
    end

    %measured = data-Analog_op;%state;
    
    measured = values(t+1);

    e_k = desired_force - measured;

    e_f = alpha*e_f_old + beta*e_k;

    e_f_old = e_f;

    % Accumulating error

    e_i = e_i_old + e_f;

    e_i_old = e_i;

    % Controller action

    V_k = KP*e_f + KI*e_i*Ts + KD*e_f*(1/Ts);

    V = V_k+Input_op; % for full range

    %disp(['data: ' num2str(data(i+1))])
    disp(['V: ' num2str(V)])
    disp(['Desire: ' num2str(desired_force)])
    %disp(['state: ' num2str(state)])

    % Limit to max 180
    % Anti-windup integral limiter
    if V>180
        V = 180;
        e_i_old = e_i_old - e_f;
    end

    if V<0
        V = 0;
        e_i_old = e_i_old - e_f;
    end
    
    V = round(V);
    
    setSup(0,0,0,V,V,V,0,0,800,800,800,800,800,800,dev); %set input of servo motors
    

    % Appending values to array for plotting
    forceArray = [forceArray, measured];
    timeArray = [timeArray, t];
    sineArray = [sineArray, sine];
end

% Set zero config
setSup(0,0,0,0,0,0,0,0,800,800,800,800,800,800,dev);

%Plotting
figure;
plot(timeArray, forceArray);
xlabel('Time');
ylabel('Force Reading');
title('Force over time');

%Plotting
figure;
plot(timeArray, sineArray);
xlabel('Time');
ylabel('Amplitude');
title('Sine Wave');

fclose(dev); %close COM port
